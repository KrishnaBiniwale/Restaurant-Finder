<!DOCTYPE html>
<html>

<head>
	<title>Restaurant Finder</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="styles.css">
	<script src="https://kit.fontawesome.com/a732f09450.js" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"
		integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
	<style>

	</style>
</head>

<body>
	<div id="map">
	</div>
	<div id="page">
		<div class="container-fluid" id="content">
			<div class="row">
				<div class="container">
					<nav class="navbar navbar-expand-lg bg-body-tertiary">
						<div class="container-fluid">
							<a class="navbar-brand col-5 fs-3" href="#">Restaurant-Finder</a>
							<div class="collapse navbar-collapse col-7" id="navbarText">
								<ul class="navbar-nav me-auto mb-2 mb-lg-0">
									<li class="nav-item">
										<a class="nav-link active fs-5" aria-current="page" href="#">Home</a>
									</li>
									<li class="nav-item">
										<a class="nav-link fs-5" href="#">Favorites</a>
									</li>
									<li class="nav-item">
										<a class="nav-link fs-5" href="#">Reservations</a>
									</li>
								</ul>
								<a class="nav-link fs-5 me-4" href="#">Login / Signup</a>
							</div>
						</div>
					</nav>
				</div>
			</div>
		</div>
		<div class="container" id="search-form">
			<div class="row justify-content-center">
				<img id="home-img" src="homepage.jpg" alt="Home Page">
			</div>
			<div class="mt-3">
				<h4 class="text-center fw-normal">Search For Restaurant</h4>
				<form name="form" id="form">
					<div class="row">
						<div class="col-8">

							<input type="radio" class="btn-check" name="search-parameter" id="best-match"
								autocomplete="off" checked>
							<label class="btn btn-outline-danger" for="best-match">Best Match</label>

							<input type="radio" class="btn-check" name="search-parameter" id="rating"
								autocomplete="off">
							<label class="btn btn-outline-danger" for="rating">Rating</label>

							<input type="radio" class="btn-check" name="search-parameter" id="review-count"
								autocomplete="off">
							<label class="btn btn-outline-danger" for="review-count">Review Count</label>

							<input type="radio" class="btn-check" name="search-parameter" id="distance"
								autocomplete="off">
							<label class="btn btn-outline-danger" for="distance">Distance</label>
						</div>
						<div class="col-4">
							<button onclick="revealMap()" type="button" class="mapbtn btn btn-lg btn-primary">
								Google Maps <i class="fa-solid fa-map-pin"></i></button>
						</div>
					</div>
					<div class="row mt-4">
						<div class="form-floating col-10">
							<input type="text" class="form-control" id="restaurant-name" placeholder="Restaurant">
							<label for="restaurant-name" class="ms-3">Restaurant Name</label>
						</div>
						<div class="col-2 my-auto">
							<button type="submit" class="btn btn-lg btn-success px-4"><i
									class="fa-solid fa-magnifying-glass"></i></button>
						</div>
					</div>
					<div class="hidden">
						<label>
							<input type="number" id="latitude" name="latitude" value="34.02116" min="-90" max="90"
								step="0.000000000000001">
						</label>
						<label>
							<input type="number" id="longitude" name="longitude" value="-118.287132" min="-180"
								max="180" step="0.000000000000001">
						</label>
					</div>
				</form>
			</div>
		</div>
		<div class="container mt-4" id="search-results">

			<div class="row text-center hidden" id="results">
				<p><em>Showing <strong><span id="numResults">0</span></strong> of <strong><span
								id="totalResults">0</span></strong>
						result(s)</em></p>
			</div>
		</div>
	</div>


	<script>

		function revealMap() {
			$('#map').show();
			document.getElementById('page').classList.add("dim");
		}

		function initMap() {
			let map_position = new google.maps.LatLng(34.02116, -118.287132);

			const myLatlng = { lat: 34.02116, lng: -118.287132 };
			const map = new google.maps.Map(document.getElementById("map"), {
				zoom: 6,
				center: map_position,
			});

			let marker = new google.maps.Marker({
				position: map_position,
				map: map
			});
			// Create the initial InfoWindow.
			let infoWindow = new google.maps.InfoWindow({});

			infoWindow.open(map);
			// Configure the click listener.
			map.addListener("click", (mapsMouseEvent) => {
				// Close the current InfoWindow.
				infoWindow.close();
				// Create a new InfoWindow.
				infoWindow = new google.maps.InfoWindow({
					position: mapsMouseEvent.latLng,
				});
				let latlong = JSON.parse(JSON.stringify(mapsMouseEvent.latLng.toJSON(), null));
				//console.log(latlong['lat'] + ", " + latlong['lng']);
				$('#map').hide();
				document.getElementById('page').classList.remove("dim");
				document.getElementById('latitude').value = latlong['lat'];
				document.getElementById('longitude').value = latlong['lng'];
			});
		}
	</script>

	<script
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCLiCh8XRH9Tkb5pyJLRYyfnK5TC_rdidg&callback=initMap&v=weekly"
		defer></script>


	<script>
		$(document).ready(function () {
			//initMap();
			$('#map').hide();

			// TODO: Update navbar based on login
			/*if (sessionStorage.getItem('loggedIn') != 'true') {
				$('#navbar-links').children(':not(#in, #home)').hide();
				$('#navbar-links').children('#in').show();
			} else {
				$('#navbar-links').children('#in').hide();
				$('#navbar-links').children(':not(#in)').show();
			}*/
		});

		// Search for restaurant
		$('#form').submit(function (e) {
			e.preventDefault();
			$('#home-img').hide();
			let formData = $(this).serialize();

			let radioButtons = form.elements['search-parameter'];
			for (let i = 0; i < radioButtons.length; i++) {
				if (radioButtons[i].checked) {
					selectedId = radioButtons[i].id;
					break;
				}
			}
			let sortTerm = selectedId.replace(/-/g, "_");

			let nameTerm = $('#form').find('#restaurant-name').val();
			let latitudeTerm = $('#form').find('#latitude').val();
			let longitudeTerm = $('#form').find('#longitude').val();


			// Define search parameters
			let params = {
				latitude: latitudeTerm,
				longitude: longitudeTerm,
				term: nameTerm,
				sort_by: sortTerm,
				limit: 20
			};
			// Base URL of the search endpoint
			let baseURL = "https://cors-anywhere.herokuapp.com/https://api.yelp.com/v3/businesses/search";

			// Construct the query URL using object literals and template literals
			let queryURL = `${baseURL}?${Object.keys(params).map(key => `${key}=${encodeURIComponent(params[key])}`).join('&')}`;
			let apiKey = "KsGd36gXbL3rlu3rd-ivS-Tlev_TS4iilgg1DmoGmIYEyEAJYJiVlfH9U6NAxHdTPmS6TdaFk3Wd_dOSLV5QnIpwuG2NyiNngMPHETdidSLzw2TyCL_QKRqc5_Q6ZXYx";
			console.log(queryURL);
			fetch(queryURL, {
				method: "GET",
				headers: {
					"accept": "application/json",
					"x-requested-with": "xmlhttprequest",
					"Access-Control-Allow-Origin": "*",
					"Authorization": `Bearer ${apiKey}`
				}
			})
				.then(response => {
					if (!response.ok) {
						throw new Error('Network response was not ok');
					}
					return response.json();
				})
				.then(result => {
					displayRestaurants(result);
				})
				.catch(error => {
					console.error('There was a problem with the fetch operation:', error);
				});

			$(this).trigger("reset");
		});

		function displayRestaurants(result) {
			let restaurants = result["businesses"];
			let numResults = document.getElementById("numResults");
			numResults.innerHTML = restaurants.length;
			let totalResults = document.getElementById("totalResults");
			totalResults.innerHTML = result["total"];

			document.getElementById("results").classList.remove("hidden");


			console.log(result);
			restaurants.forEach(function (restaurant) {
				//console.log(restaurant);
			});
		}


		// Toggle details for restaurant images
		$(document).on('click', '.restaurant-img img', function () {
			restaurantdiv = $(this).closest('.restaurant');
			let toggled = restaurantdiv.children('.restaurant-details').is(':hidden');
			if (toggled) {
				$('.restaurant').not(restaurantdiv).hide();
				$('hr').not($('#search-term').next(), $('#navbar-hr')).hide();
				let index = 0;
				for (index = 0; index < 10; index++) {
					if (restaurants['businesses'][index]["name"].includes(restaurantdiv.children('.restaurant-desc').children('h3').text())) {
						break;
					}
				}

				restaurantdiv.children('.restaurant-desc').hide();
				restaurantdiv.children('.restaurant-details').show();
				currentrestaurant = restaurants['businesses'][index];
				original_search = $('#search-term').html();
				$('#search-term').html(currentrestaurant['name']);
				if (sessionStorage.getItem('loggedIn') == 'true') {
					// Check if restaurant has already been favorited
					let data = {
						username: sessionStorage.getItem('username'),
						restaurantName: currentrestaurant['name']
					}
					$.ajax({
						type: "POST",
						url: "Favorites",
						data: data,
						success: function (response) {
							if (response.trim() == 'true') {
								restaurantdiv.next().children().html("<i class='fa fa-star'> Remove from favorites");
								favorited = true;
							} else {
								favorited = false;
							}
						}, error: function (error) {
							alert("Favoriting error");
						}
					});
					//
					restaurantdiv.next().show();
					restaurantdiv.next().next().show();
				} else {
					restaurantdiv.next().hide();
					restaurantdiv.next().next().hide();
				}
			} else {
				window.location = restaurantdiv.children('.restaurant-desc').children('.url-link').text();
			}
		});

		// When add to reservation is clicked
		$(document).on('click', '.add-to-reservations', function () {
			if ($(this).next().is(':hidden')) {
				$(this).next().show();
			} else {
				$(this).next().hide();
			}
		});

		// When add to favorites is clicked
		$(document).on('click', '.add-to-favorites', function () {
			let favoritesbutton = $(this).children();
			if (!favorited) {
				// ADD TO FAVORITES
				let favoritedata = {};
				favoritedata['name'] = currentrestaurant['name'];
				favoritedata['address'] = currentrestaurant["location"]["display_address"].join(' ');
				favoritedata['image'] = currentrestaurant["image_url"];
				favoritedata['url'] = currentrestaurant["url"].split('?')[0];
				favoritedata['phone'] = currentrestaurant["display_phone"];
				favoritedata['cuisine'] = currentrestaurant["categories"][0]["title"]
				favoritedata['price'] = currentrestaurant['price'];
				favoritedata['rating'] = currentrestaurant['rating'];
				favoritedata['username'] = sessionStorage.getItem('username');
				$.ajax({
					type: "POST",
					url: "Favorites",
					data: favoritedata,
					success: function (response) {
						favoritesbutton.html("<i class='fa fa-star'> Remove from favorites");
						favorited = true;
					}, error: function (error) {
						alert("Favoriting error");
					}
				});
			} else {
				// REMOVE IT FROM FAVORITES
				let favoritedata = {};
				favoritedata['username'] = sessionStorage.getItem('username');
				favoritedata['name'] = currentrestaurant['name'];
				favoritedata['changeback'] = 'yes';
				$.ajax({
					type: "POST",
					url: "Favorites",
					data: favoritedata,
					success: function (response) {
						favoritesbutton.html("<i class='fa fa-star'> Add to favorites");
						favorited = false;
					}, error: function (error) {
						alert("Favoriting error");
					}
				});
			}
		});

		// Submit reservations
		$(document).on('submit', '.reservation', function (e) {
			e.preventDefault();
			console.log("Reservation submitted");
			reservationdataform = $(this).serialize();
			const params = new URLSearchParams(reservationdataform);

			const dateInputValue = params.get('dateInput');
			const timeInputValue = params.get('timeInput');

			reservationdata = {};
			reservationdata['date'] = dateInputValue;
			reservationdata['time'] = timeInputValue;
			reservationdata['text'] = reservationdataform['text'];
			reservationdata['name'] = currentrestaurant['name'];
			reservationdata['address'] = currentrestaurant["location"]["display_address"].join(' ');
			reservationdata['image'] = currentrestaurant["image_url"];
			reservationdata['url'] = currentrestaurant["url"].split('?')[0];
			reservationdata['phone'] = currentrestaurant["display_phone"];
			reservationdata['cuisine'] = currentrestaurant["categories"][0]["title"];
			reservationdata['price'] = currentrestaurant['price'];
			reservationdata['rating'] = currentrestaurant['rating'];
			reservationdata['username'] = sessionStorage.getItem('username');
			console.log(reservationdata);
			$(this).hide();
			$.ajax({
				type: "POST",
				url: "Reservations",
				data: reservationdata,
				success: function (response) {
					console.log('Reservation was successful');
				}, error: function (error) {
					alert("Reservation error");
				}
			});
			$(this).trigger("reset");
		});
	</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>